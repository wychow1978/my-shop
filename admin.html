<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—é“ºåå° - è‡ªåŠ¨åŒæ­¥ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* é…ç½®åŒºåŸŸ */
        .config-box { background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ffeeba; }
        .config-box input { padding: 5px; margin-right: 10px; width: 200px; }
        
        /* è¡¨æ ¼ä¸è¡¨å•æ ·å¼ (ä¿æŒä¸å˜) */
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .search-box { flex: 1; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f8f8; font-weight: bold; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .status-active { background: #e6fffa; color: #00796b; border: 1px solid #b2f5ea; }
        .status-inactive { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; }

        .add-form { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; padding: 15px; background: #ebf8ff; border-radius: 8px; margin-bottom: 20px; align-items: end; }
        .form-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #666; }
        .form-group input { width: 100%; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .btn-add { background: #3182ce; }
        .btn-save { background: #2f855a; width: 100%; font-size: 1.2rem; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš€ åº—é“ºäº‘åå° (GitHub ç›´è¿)</h1>

    <div class="config-box">
        <h3>ğŸ”‘ GitHub è®¾ç½® (é¦–æ¬¡ä½¿ç”¨è¯·å¡«å†™)</h3>
        <div>
            <label>ç”¨æˆ·å:</label> <input type="text" id="ghOwner" placeholder="ä¾‹å¦‚: wychow1978">
            <label>ä»“åº“å:</label> <input type="text" id="ghRepo" placeholder="ä¾‹å¦‚: my-shop">
            <label>Token:</label> <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
            <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
        </div>
        <small style="color:#666">è¿™äº›ä¿¡æ¯åªä¿å­˜åœ¨ä½ çš„ç”µè„‘æµè§ˆå™¨é‡Œã€‚</small>
    </div>

    <div class="add-form">
        <div class="form-group"><label>ID</label><input type="text" id="newId" placeholder="cup-001"></div>
        <div class="form-group"><label>åç§°</label><input type="text" id="newName" placeholder="æ–°äº§å“"></div>
        <div class="form-group"><label>ä»·æ ¼</label><input type="number" id="newPrice" placeholder="25.00"></div>
        <div class="form-group"><label>å›¾ç‰‡</label><input type="text" id="newImg" value="product_images/"></div>
        <button class="btn btn-add" onclick="addNewProduct()">+ æ·»åŠ </button>
    </div>

    <div class="toolbar">
        <input type="text" class="search-box" id="searchInput" placeholder="æœç´¢äº§å“..." onkeyup="renderTable()">
    </div>

    <table>
        <thead>
            <tr><th>çŠ¶æ€</th><th>ID</th><th>å›¾ç‰‡</th><th>åç§°</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button id="saveBtn" class="btn btn-save" onclick="saveToGithub()">ğŸ’¾ ä¿å­˜å¹¶å‘å¸ƒåˆ° GitHub</button>
    <p id="statusMsg" style="text-align: center; margin-top: 10px; color: #666;"></p>
</div>

<script src="products.js"></script>

<script>
    // åˆå§‹åŒ–æ•°æ®
    let currentData = (typeof allProducts !== 'undefined') ? allProducts : [];
    
    // é¡µé¢åŠ è½½æ—¶ï¼Œä»æœ¬åœ°ç¼“å­˜è¯»å– GitHub é…ç½®
    window.onload = function() {
        document.getElementById('ghOwner').value = localStorage.getItem('gh_owner') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
        renderTable();
    };

    function saveConfig() {
        localStorage.setItem('gh_owner', document.getElementById('ghOwner').value);
        localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
        localStorage.setItem('gh_token', document.getElementById('ghToken').value);
        alert("é…ç½®å·²ä¿å­˜ï¼");
    }

    // æ¸²æŸ“è¡¨æ ¼ (ä¿æŒä¸å˜)
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';

        currentData.forEach((item, index) => {
            if (!item.name.toLowerCase().includes(searchTerm) && !item.id.toLowerCase().includes(searchTerm)) return;
            const statusClass = item.active ? 'status-active' : 'status-inactive';
            const statusText = item.active ? 'ä¸Šæ¶' : 'ä¸‹æ¶';
            
            tbody.innerHTML += `
                <tr>
                    <td><span class="status-badge ${statusClass}" onclick="toggleStatus(${index})">${statusText}</span></td>
                    <td>${item.id}</td>
                    <td><img src="${item.image}" style="height:30px;"></td>
                    <td contenteditable="true" onblur="updateName(${index}, this.innerText)">${item.name}</td>
                    <td contenteditable="true" onblur="updatePrice(${index}, this.innerText)">$${item.price}</td>
                    <td><button onclick="deleteProduct(${index})" style="color:red;border:none;background:none;cursor:pointer">åˆ é™¤</button></td>
                </tr>`;
        });
    }

    function toggleStatus(i) { currentData[i].active = !currentData[i].active; renderTable(); }
    function updateName(i, v) { currentData[i].name = v; }
    function updatePrice(i, v) { currentData[i].price = parseFloat(v.replace('$','')); }
    function deleteProduct(i) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { currentData.splice(i, 1); renderTable(); } }
    
    function addNewProduct() {
        currentData.push({
            id: document.getElementById('newId').value,
            name: document.getElementById('newName').value,
            price: parseFloat(document.getElementById('newPrice').value),
            image: document.getElementById('newImg').value,
            active: true
        });
        renderTable();
        alert("å·²æ·»åŠ ï¼Œè®°å¾—ç‚¹åº•éƒ¨ä¿å­˜æŒ‰é’®ï¼");
    }

    // --- æ ¸å¿ƒï¼šè°ƒç”¨ GitHub API ---
    async function saveToGithub() {
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;
        const token = document.getElementById('ghToken').value;
        const path = "products.js"; // æˆ‘ä»¬è¦ä¿®æ”¹çš„æ–‡ä»¶å

        if(!owner || !repo || !token) return alert("è¯·å…ˆå¡«å†™é¡¶éƒ¨çš„ GitHub é…ç½®ï¼");

        const btn = document.getElementById('saveBtn');
        const msg = document.getElementById('statusMsg');
        
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨è¿æ¥ GitHub...";
        msg.innerText = "æ­¥éª¤ 1/2: è·å–æ–‡ä»¶ä¿¡æ¯...";

        try {
            // 1. å…ˆè·å–æ–‡ä»¶çš„ SHA (GitHub ä¿®æ”¹æ–‡ä»¶å¿…é¡»æä¾›ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ SHA)
            const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            const getRes = await fetch(getUrl, {
                headers: { "Authorization": `token ${token}` }
            });
            const getJson = await getRes.json();
            const sha = getJson.sha;

            msg.innerText = "æ­¥éª¤ 2/2: ä¸Šä¼ æ–°ä»£ç ...";

            // 2. å‡†å¤‡æ–°å†…å®¹
            const jsonString = JSON.stringify(currentData, null, 4);
            const newContent = `// è¿™æ˜¯ä½ çš„â€œæ€»æ•°æ®åº“â€ï¼ŒåŒ…å«æ‰€æœ‰ï¼ˆä¸Šæ¶å’Œä¸‹æ¶ï¼‰çš„äº§å“\n// ä»¥åè¯·æŠŠ admin.html ç”Ÿæˆçš„ä»£ç ç²˜è´´è¦†ç›–è¿™é‡Œ\nconst allProducts = ${jsonString};\n\n// è¿™ä¸€è¡Œä»£ç åªâ€œè¿‡æ»¤â€å‡º active: true çš„äº§å“ç»™ index.html ä½¿ç”¨\nconst products = allProducts.filter(p => p.active === true);`;

            // GitHub API è¦æ±‚å†…å®¹å¿…é¡»æ˜¯ Base64 ç¼–ç ï¼Œå¹¶ä¸”è¦å¤„ç†ä¸­æ–‡ç¼–ç é—®é¢˜
            const contentEncoded = btoa(unescape(encodeURIComponent(newContent)));

            // 3. å‘é€ PUT è¯·æ±‚æ›´æ–°æ–‡ä»¶
            const putRes = await fetch(getUrl, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Update products from Admin Panel", // æäº¤ä¿¡æ¯
                    content: contentEncoded,
                    sha: sha // å¿…é¡»å¸¦ä¸Šè¿™ä¸ª
                })
            });

            if (putRes.ok) {
                alert("ğŸ‰ æˆåŠŸï¼GitHub å·²æ›´æ–°ï¼ŒNetlify æ­£åœ¨é‡æ–°å‘å¸ƒï¼\nè¯·ç­‰å¾…çº¦ 30 ç§’ååˆ·æ–°ç½‘åº—ã€‚");
                msg.innerText = "âœ… æ›´æ–°æˆåŠŸï¼";
            } else {
                throw new Error("GitHub æ‹’ç»äº†è¯·æ±‚");
            }

        } catch (err) {
            console.error(err);
            alert("âŒ å¤±è´¥äº†ï¼è¯·æ£€æŸ¥ï¼š\n1. ç”¨æˆ·å/ä»“åº“åå¯¹ä¸å¯¹ï¼Ÿ\n2. Token å¤åˆ¶å¯¹äº†å—ï¼Ÿ\n3. Token æ˜¯å¦è¿‡æœŸï¼Ÿ");
            msg.innerText = "âŒ å‘ç”Ÿé”™è¯¯";
        }

        btn.disabled = false;
        btn.innerText = "ğŸ’¾ ä¿å­˜å¹¶å‘å¸ƒåˆ° GitHub";
    }
</script>

</body>
</html>
