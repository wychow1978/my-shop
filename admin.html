<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyShop ç³»ç»Ÿåå°</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f6f8; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* é¡¶éƒ¨é…ç½® */
        .config-box { background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffeeba; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; flex-wrap: wrap; }
        .config-inputs input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }

        /* æ ‡ç­¾é¡µ (Tabs) */
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; }
        .tab-btn { padding: 12px 25px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; background: none; color: #718096; transition: 0.3s; border-bottom: 3px solid transparent; }
        .tab-btn:hover { color: #3182ce; }
        .tab-btn.active { color: #3182ce; border-bottom: 3px solid #3182ce; }
        
        /* å†…å®¹åŒºåŸŸ */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* è¡¨æ ¼ä¸å·¥å…·æ  */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
        input.search-box { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9rem; }
        th { background: #edf2f7; padding: 12px; text-align: left; color: #4a5568; font-weight: 700; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        /* æŒ‰é’® */
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-primary { background: #3182ce; color: white; }
        .btn-success { background: #38a169; color: white; }
        .btn-danger { background: #fff5f5; color: #e53e3e; border: 1px solid #fed7d7; }
        .btn-whatsapp { background: #25D366; color: white; text-decoration: none; padding: 6px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 4px; }
        .btn-save-cloud { width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; display: block; }

        /* å®¢æˆ·è¯¦æƒ…å¡ç‰‡ */
        .stats-badge { background: #ebf8ff; color: #2b6cb0; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px; }
        .history-row { background: #fafafa; display: none; }
        .history-box { padding: 15px; margin: 10px; border: 1px dashed #cbd5e0; border-radius: 8px; }
        .total-summary { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; color: #2d3748; }
        
        /* æ–°å»ºå®¢æˆ·æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
        .modal-box { background:white; padding:25px; border-radius:10px; width:400px; }
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; margin-bottom:5px; font-weight:bold; }
        .form-group input, .form-group select { width:100%; padding:8px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-box">
        <span>ğŸ”— GitHub åŒæ­¥è®¾ç½®</span>
        <input type="text" id="ghOwner" placeholder="ç”¨æˆ·å (Owner)">
        <input type="text" id="ghRepo" placeholder="ä»“åº“å (Repo)">
        <input type="password" id="ghToken" placeholder="Token (ghp_...)">
        <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="openTab('products')">ğŸ“¦ äº§å“åº“</div>
        <div class="tab-btn" onclick="openTab('customers')">ğŸ‘¥ å®¢æˆ·ä¸è®¢å•</div>
    </div>

    <div id="tab-products" class="tab-content active">
        <div class="toolbar">
            <input type="text" id="prodSearch" class="search-box" placeholder="æœç´¢äº§å“..." onkeyup="renderProducts()">
            <button class="btn btn-primary" onclick="addNewProduct()">+ æ–°äº§å“</button>
        </div>
        <table>
            <thead><tr><th>çŠ¶æ€</th><th>ID</th><th>å›¾ç‰‡</th><th>åç§°</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="prodBody"></tbody>
        </table>
        <button class="btn btn-success btn-save-cloud" onclick="saveToGithub('products')">ğŸ’¾ ä¿å­˜äº§å“åˆ—è¡¨åˆ° GitHub</button>
    </div>

    <div id="tab-customers" class="tab-content">
        <div class="toolbar">
            <input type="text" id="custSearch" class="search-box" placeholder="æœç´¢å§“åæˆ–ç”µè¯..." onkeyup="renderCustomers()">
            <button class="btn btn-primary" onclick="openAddCustModal()">+ å½•å…¥æ–°å®¢æˆ·</button>
        </div>
        <table>
            <thead><tr><th>å®¢æˆ·èµ„æ–™</th><th>ç»Ÿè®¡æ•°æ®</th><th>å¤‡æ³¨ (Admin)</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="custBody"></tbody>
        </table>
        <button class="btn btn-success btn-save-cloud" onclick="saveToGithub('customers')">ğŸ’¾ ä¿å­˜å®¢æˆ·åˆ—è¡¨åˆ° GitHub</button>
    </div>
</div>

<div id="addCustModal" class="modal">
    <div class="modal-box">
        <h3>ğŸ‘¤ å½•å…¥æ–°å®¢æˆ·</h3>
        <div class="form-group"><label>å§“å</label><input type="text" id="newCName"></div>
        <div class="form-group">
            <label>å›½å®¶/åœ°åŒº</label>
            <select id="newCCode">
                <option value="+60">ğŸ‡²ğŸ‡¾ é©¬æ¥è¥¿äºš (+60)</option>
                <option value="+65">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (+65)</option>
                <option value="+86">ğŸ‡¨ğŸ‡³ ä¸­å›½ (+86)</option>
            </select>
        </div>
        <div class="form-group"><label>ç”µè¯å·ç </label><input type="text" id="newCPhone" placeholder="ä¾‹å¦‚: 123456789"></div>
        <div class="form-group"><label>åˆå§‹å¯†ç </label><input type="text" id="newCPass" value="123456"></div>
        <div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="newCNotes"></div>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmAddCust()">ç¡®å®šæ·»åŠ </button>
        </div>
    </div>
</div>

<p id="statusMsg" style="text-align: center; color: #666; margin-top:10px;"></p>

<script src="products.js"></script>
<script src="customers.js"></script>

<script>
    // --- 1. åˆå§‹åŒ– ---
    let productList = (typeof allProducts !== 'undefined') ? allProducts : [];
    let customerList = (typeof allCustomers !== 'undefined') ? allCustomers : [];

    window.onload = function() {
        document.getElementById('ghOwner').value = localStorage.getItem('gh_owner') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
        renderProducts();
        renderCustomers();
    };

    function saveConfig() {
        localStorage.setItem('gh_owner', document.getElementById('ghOwner').value);
        localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
        localStorage.setItem('gh_token', document.getElementById('ghToken').value);
        alert("é…ç½®å·²ä¿å­˜ï¼");
    }

    // --- Tab åˆ‡æ¢é€»è¾‘ (ä¿®å¤ç‰ˆ) ---
    function openTab(tabName) {
        // éšè—æ‰€æœ‰å†…å®¹
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // æ˜¾ç¤ºç›®æ ‡
        document.getElementById('tab-' + tabName).classList.add('active');
        // é«˜äº®æŒ‰é’® (é€šè¿‡æŸ¥æ‰¾æ–‡æœ¬å†…å®¹æˆ–è€…ç´¢å¼•ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†)
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName === 'products') btns[0].classList.add('active');
        else btns[1].classList.add('active');
    }

    // --- 2. äº§å“åŠŸèƒ½ (ä¿æŒç²¾ç®€) ---
    function renderProducts() {
        const tbody = document.getElementById('prodBody');
        const term = document.getElementById('prodSearch').value.toLowerCase();
        tbody.innerHTML = '';
        productList.forEach((p, i) => {
            if(!p.name.toLowerCase().includes(term)) return;
            tbody.innerHTML += `
                <tr>
                    <td><span style="cursor:pointer; color:${p.active?'green':'red'}" onclick="toggleProd(${i})">${p.active?'â— ä¸Šæ¶':'â—‹ ä¸‹æ¶'}</span></td>
                    <td contenteditable="true" onblur="updProd(${i},'id',this.innerText)">${p.id}</td>
                    <td><img src="${p.image}" style="height:30px"></td>
                    <td contenteditable="true" onblur="updProd(${i},'name',this.innerText)">${p.name}</td>
                    <td contenteditable="true" onblur="updProd(${i},'price',this.innerText)">${p.price}</td>
                    <td><button class="btn btn-danger" onclick="delProd(${i})">åˆ </button></td>
                </tr>`;
        });
    }
    function updProd(i, k, v) { productList[i][k] = (k==='price')?parseFloat(v):v; }
    function toggleProd(i) { productList[i].active = !productList[i].active; renderProducts(); }
    function delProd(i) { if(confirm("åˆ é™¤?")) productList.splice(i,1); renderProducts(); }
    function addNewProduct() { productList.push({id:"new",name:"æ–°äº§å“",price:0,image:"",active:false}); renderProducts(); }

    // --- 3. å®¢æˆ·åŠŸèƒ½ (æ ¸å¿ƒå‡çº§) ---
    function renderCustomers() {
        const tbody = document.getElementById('custBody');
        const term = document.getElementById('custSearch').value.toLowerCase();
        tbody.innerHTML = '';

        customerList.forEach((c, i) => {
            // æœç´¢è¿‡æ»¤
            const fullPhone = (c.country_code||"") + c.phone;
            if(!c.name.toLowerCase().includes(term) && !fullPhone.includes(term)) return;

            // ç»Ÿè®¡é€»è¾‘
            const orderCount = c.history ? c.history.length : 0;
            const totalSpent = c.history ? c.history.reduce((sum, h) => sum + (h.amount||0), 0) : 0;
            const lastBuy = orderCount > 0 ? c.history[0].date : "æ— ";

            tbody.innerHTML += `
                <tr>
                    <td>
                        <div style="font-weight:bold; font-size:1rem;">${c.name}</div>
                        <div style="color:#666; font-size:0.85rem;">
                             ${c.country_code || '+60'} ${c.phone} 
                             <a href="https://wa.me/${(c.country_code||'60').replace('+','')}${c.phone}" target="_blank" class="btn-whatsapp">ğŸ“²</a>
                        </div>
                        <div style="font-size:0.8rem; color:#999;">å¯†ç : ${c.password||'æœªè®¾'}</div>
                    </td>
                    <td>
                        <span class="stats-badge">ğŸ“¦ ${orderCount} å•</span>
                        <span class="stats-badge">ğŸ’° $${totalSpent}</span>
                        <div style="font-size:0.8rem; margin-top:5px; color:#666;">æœ€è¿‘: ${lastBuy}</div>
                    </td>
                    <td contenteditable="true" onblur="updCust(${i},'notes',this.innerText)" style="background:#fffef0; border:1px solid #eee;">${c.notes||''}</td>
                    <td>
                        <button class="btn btn-primary" onclick="toggleHistory(${i})">æŸ¥çœ‹è¯¦æƒ… / è®°å•</button>
                        <button class="btn btn-danger" onclick="delCust(${i})" style="margin-left:5px;">ğŸ—‘ï¸</button>
                    </td>
                </tr>
                <tr id="hist-row-${i}" class="history-row">
                    <td colspan="4">
                        <div class="history-box">
                            <div class="total-summary">æ€»æ¶ˆè´¹: $${totalSpent} (å…± ${orderCount} æ¬¡è´­ä¹°)</div>
                            <button class="btn btn-primary" style="margin-bottom:10px;" onclick="addManualOrder(${i})">+ æ‰‹åŠ¨æ·»åŠ æ–°è®¢å•</button>
                            <table style="background:white;">
                                <thead><tr><th>æ—¥æœŸ</th><th>å•å·</th><th>äº§å“</th><th>é‡‘é¢</th></tr></thead>
                                <tbody>
                                    ${c.history && c.history.length > 0 ? c.history.map(h => `
                                        <tr>
                                            <td>${h.date}</td>
                                            <td>${h.invoice}</td>
                                            <td>${h.items}</td>
                                            <td><strong>$${h.amount}</strong></td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4" style="text-align:center;color:#999;">æš‚æ— å†å²è®°å½•</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function updCust(i, k, v) { customerList[i][k] = v; }
    function delCust(i) { if(confirm("ç¡®å®šåˆ é™¤æ­¤å®¢æˆ·åŠæ‰€æœ‰å†å²æ•°æ®?")) { customerList.splice(i,1); renderCustomers(); } }
    function toggleHistory(i) { const el = document.getElementById(`hist-row-${i}`); el.style.display = el.style.display==='table-row'?'none':'table-row'; }

    // æ‰‹åŠ¨è®°å• (Adminå¸®ä½ è®°)
    function addManualOrder(i) {
        const amount = prompt("é‡‘é¢ ($):");
        if(!amount) return;
        const items = prompt("è´­ä¹°äº†ä»€ä¹ˆäº§å“?");
        const newOrder = {
            date: new Date().toISOString().split('T')[0],
            invoice: "MANUAL-" + Date.now().toString().slice(-4),
            items: items || "çº¿ä¸‹è®¢å•",
            amount: parseFloat(amount)
        };
        if(!customerList[i].history) customerList[i].history = [];
        customerList[i].history.unshift(newOrder); // åŠ åˆ°æœ€å‰é¢
        renderCustomers();
        // ä¿æŒå±•å¼€çŠ¶æ€
        document.getElementById(`hist-row-${i}`).style.display = 'table-row';
    }

    // --- å¼¹çª—ç›¸å…³ ---
    function openAddCustModal() { document.getElementById('addCustModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('addCustModal').style.display = 'none'; }
    
    function confirmAddCust() {
        const name = document.getElementById('newCName').value;
        const code = document.getElementById('newCCode').value;
        const phone = document.getElementById('newCPhone').value;
        const pass = document.getElementById('newCPass').value;
        const notes = document.getElementById('newCNotes').value;

        if(!name || !phone) return alert("å§“åå’Œç”µè¯å¿…å¡«ï¼");

        customerList.push({
            id: "cust-" + Date.now(),
            name: name,
            country_code: code,
            phone: phone,
            password: pass,
            notes: notes,
            history: []
        });
        
        renderCustomers();
        closeModal();
        // æ¸…ç©ºè¡¨å•
        document.getElementById('newCName').value = '';
        document.getElementById('newCPhone').value = '';
    }

    // --- 4. ä¿å­˜åˆ° GitHub (æ ¸å¿ƒ) ---
    async function saveToGithub(type) {
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;
        const token = document.getElementById('ghToken').value;
        if(!owner || !repo || !token) return alert("è¯·å¡«å†™ GitHub é…ç½®");

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "â³ è¿æ¥ä¸­...";
        btn.disabled = true;

        const fileName = (type==='products') ? 'products.js' : 'customers.js';
        const data = (type==='products') ? productList : customerList;
        const varName = (type==='products') ? 'allProducts' : 'allCustomers';
        const extra = (type==='products') ? '\nconst products = allProducts.filter(p => p.active === true);' : '';

        try {
            // 1. Get SHA
            const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`;
            const getRes = await fetch(getUrl, { headers: { "Authorization": `token ${token}` } });
            const getJson = await getRes.json();
            const sha = getRes.ok ? getJson.sha : null;

            // 2. Upload
            const content = `// ${type} Data\nconst ${varName} = ${JSON.stringify(data, null, 4)};${extra}`;
            const encoded = btoa(unescape(encodeURIComponent(content))); // Fixed Chinese chars
            
            const putRes = await fetch(getUrl, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ message: `Update ${type}`, content: encoded, sha: sha })
            });

            if(putRes.ok) { alert("âœ… ä¿å­˜æˆåŠŸ!"); } 
            else { throw new Error("GitHub æ‹’ç»è¯·æ±‚"); }

        } catch(e) { alert("âŒ å¤±è´¥: " + e.message); }
        
        btn.innerText = originalText;
        btn.disabled = false;
    }
</script>

</body>
</html>
