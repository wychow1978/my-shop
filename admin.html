<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyShop è¶…çº§åå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        .config-box { background: #fff8e1; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffe082; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }
        .config-inputs input { border: 1px solid #ccc; padding: 4px; border-radius: 4px; width: 150px; }

        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-btn { padding: 15px 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: none; background: none; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #3182ce; border-bottom: 3px solid #3182ce; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
        input.search-box { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.95rem; }
        th { background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #edf2f7; color: #4a5568; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #f9fafb; }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: #3182ce; color: white; }
        .btn-success { background: #38a169; color: white; }
        .btn-danger { color: #e53e3e; background: none; }
        .btn-whatsapp { background: #25D366; color: white; text-decoration: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; }
        .btn-save-cloud { width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 20px; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .active-badge { background: #c6f6d5; color: #22543d; }
        .inactive-badge { background: #fed7d7; color: #822727; }

        .history-row { background: #fafafa; display: none; }
        .history-box { padding: 15px; margin: 10px 20px; border: 1px dashed #cbd5e0; border-radius: 6px; font-size: 0.9rem; }
        .history-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-box">
        <span>ğŸ”‘ GitHub è®¾ç½®</span>
        <div class="config-inputs">
            <input type="text" id="ghOwner" placeholder="GitHubç”¨æˆ·å">
            <input type="text" id="ghRepo" placeholder="ä»“åº“å">
            <input type="password" id="ghToken" placeholder="Token">
            <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('products')">ğŸ“¦ äº§å“ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab('customers')">ğŸ‘¥ å®¢æˆ·ä¸è®¢å•</button>
    </div>

    <div id="tab-products" class="tab-content active">
        <div class="toolbar">
            <input type="text" id="prodSearch" class="search-box" placeholder="ğŸ” æœç´¢äº§å“..." onkeyup="renderProducts()">
            <button class="btn btn-primary" onclick="addNewProduct()">+ æ–°äº§å“</button>
        </div>
        <table>
            <thead><tr><th>çŠ¶æ€</th><th>ID</th><th>å›¾</th><th>åç§°</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="prodBody"></tbody>
        </table>
        <button id="btnSaveProd" class="btn btn-success btn-save-cloud" onclick="saveToGithub('products')">ğŸ’¾ ä¿å­˜ã€äº§å“åˆ—è¡¨ã€‘åˆ° GitHub</button>
    </div>

    <div id="tab-customers" class="tab-content">
        <div class="toolbar">
            <input type="text" id="custSearch" class="search-box" placeholder="ğŸ” æœç´¢å®¢æˆ·..." onkeyup="renderCustomers()">
            <button class="btn btn-primary" onclick="addNewCustomer()">+ æ–°å®¢æˆ·</button>
        </div>
        <table>
            <thead><tr><th>å§“å</th><th>ç”µè¯ (WhatsApp)</th><th>å¤‡æ³¨</th><th>å†å²è®¢å•</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="custBody"></tbody>
        </table>
        <button id="btnSaveCust" class="btn btn-success btn-save-cloud" onclick="saveToGithub('customers')">ğŸ’¾ ä¿å­˜ã€å®¢æˆ·åˆ—è¡¨ã€‘åˆ° GitHub</button>
    </div>
    
    <p id="statusMsg" style="text-align: center; margin-top: 15px; color: #666;"></p>
</div>

<script src="products.js"></script>
<script src="customers.js"></script>

<script>
    // 1. åˆå§‹åŒ– (é˜²æ­¢æ–‡ä»¶ä¸å­˜åœ¨æ—¶æŠ¥é”™)
    let productList = (typeof allProducts !== 'undefined') ? allProducts : [];
    let customerList = (typeof allCustomers !== 'undefined') ? allCustomers : [];

    window.onload = function() {
        document.getElementById('ghOwner').value = localStorage.getItem('gh_owner') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
        renderProducts();
        renderCustomers();
    };

    function saveConfig() {
        localStorage.setItem('gh_owner', document.getElementById('ghOwner').value);
        localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
        localStorage.setItem('gh_token', document.getElementById('ghToken').value);
        alert("é…ç½®å·²ä¿å­˜ï¼");
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    }

    // 2. äº§å“é€»è¾‘
    function renderProducts() {
        const tbody = document.getElementById('prodBody');
        const term = document.getElementById('prodSearch').value.toLowerCase();
        tbody.innerHTML = '';
        productList.forEach((p, i) => {
            if(!p.name.toLowerCase().includes(term)) return;
            tbody.innerHTML += `
                <tr>
                    <td><span class="badge ${p.active?'active-badge':'inactive-badge'}" onclick="toggleProd(${i})">${p.active?'ä¸Šæ¶':'ä¸‹æ¶'}</span></td>
                    <td contenteditable="true" onblur="updateProd(${i}, 'id', this.innerText)">${p.id}</td>
                    <td><img src="${p.image}" style="height:30px"></td>
                    <td contenteditable="true" onblur="updateProd(${i}, 'name', this.innerText)">${p.name}</td>
                    <td contenteditable="true" onblur="updateProd(${i}, 'price', this.innerText)">${p.price}</td>
                    <td><button class="btn btn-danger" onclick="delProd(${i})">åˆ </button></td>
                </tr>`;
        });
    }
    function addNewProduct() { productList.push({ id: "new-"+Date.now(), name: "æ–°äº§å“", price: 0, image: "product_images/cup.jpg", active: false }); renderProducts(); }
    function updateProd(i, key, val) { productList[i][key] = (key==='price') ? parseFloat(val) : val; }
    function toggleProd(i) { productList[i].active = !productList[i].active; renderProducts(); }
    function delProd(i) { if(confirm("åˆ é™¤?")) { productList.splice(i,1); renderProducts(); } }

    // 3. å®¢æˆ·é€»è¾‘
    function renderCustomers() {
        const tbody = document.getElementById('custBody');
        const term = document.getElementById('custSearch').value.toLowerCase();
        tbody.innerHTML = '';
        customerList.forEach((c, i) => {
            if(!c.name.toLowerCase().includes(term) && !c.phone.includes(term)) return;
            let totalSpent = c.history ? c.history.reduce((sum, h) => sum + (h.amount||0), 0) : 0;
            tbody.innerHTML += `
                <tr>
                    <td contenteditable="
