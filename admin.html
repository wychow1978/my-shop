<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyShop è¶…çº§åå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        /* é¡¶éƒ¨é…ç½®åŒº */
        .config-box { background: #fff8e1; padding: 10px 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffe082; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; }
        .config-inputs input { border: 1px solid #ccc; padding: 4px; border-radius: 4px; width: 150px; }

        /* æ ‡ç­¾é¡µåˆ‡æ¢ (Tabs) */
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-btn { padding: 15px 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border: none; background: none; color: #888; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #3182ce; border-bottom: 3px solid #3182ce; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼æ ·å¼ */
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
        input.search-box { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.95rem; }
        th { background: #f7fafc; padding: 12px; text-align: left; border-bottom: 2px solid #edf2f7; color: #4a5568; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #f9fafb; }

        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: #3182ce; color: white; }
        .btn-success { background: #38a169; color: white; }
        .btn-danger { color: #e53e3e; background: none; }
        .btn-whatsapp { background: #25D366; color: white; text-decoration: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; }
        .btn-save-cloud { width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 20px; }
        
        /* çŠ¶æ€å¾½ç«  */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .active-badge { background: #c6f6d5; color: #22543d; }
        .inactive-badge { background: #fed7d7; color: #822727; }

        /* å®¢æˆ·å†å²è®°å½•åŒºåŸŸ */
        .history-row { background: #fafafa; display: none; }
        .history-box { padding: 15px; margin: 10px 20px; border: 1px dashed #cbd5e0; border-radius: 6px; font-size: 0.9rem; }
        .history-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 5px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="config-box">
        <span>ğŸ”‘ GitHub è®¾ç½® (è‡ªåŠ¨è¯»å–ç¼“å­˜)</span>
        <div class="config-inputs">
            <input type="text" id="ghOwner" placeholder="GitHubç”¨æˆ·å">
            <input type="text" id="ghRepo" placeholder="ä»“åº“å">
            <input type="password" id="ghToken" placeholder="Token">
            <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('products')">ğŸ“¦ äº§å“ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab('customers')">ğŸ‘¥ å®¢æˆ·ä¸è®¢å•</button>
    </div>

    <div id="tab-products" class="tab-content active">
        <div class="toolbar">
            <input type="text" id="prodSearch" class="search-box" placeholder="ğŸ” æœç´¢äº§å“..." onkeyup="renderProducts()">
            <button class="btn btn-primary" onclick="addNewProduct()">+ æ–°äº§å“</button>
        </div>
        <table>
            <thead><tr><th>çŠ¶æ€</th><th>ID</th><th>å›¾</th><th>åç§°</th><th>ä»·æ ¼</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="prodBody"></tbody>
        </table>
        <button id="btnSaveProd" class="btn btn-success btn-save-cloud" onclick="saveToGithub('products')">ğŸ’¾ ä¿å­˜ã€äº§å“åˆ—è¡¨ã€‘åˆ° GitHub</button>
    </div>

    <div id="tab-customers" class="tab-content">
        <div class="toolbar">
            <input type="text" id="custSearch" class="search-box" placeholder="ğŸ” æœç´¢å®¢æˆ·åå­—æˆ–ç”µè¯..." onkeyup="renderCustomers()">
            <button class="btn btn-primary" onclick="addNewCustomer()">+ æ–°å®¢æˆ·</button>
        </div>
        <table>
            <thead><tr><th>å§“å</th><th>ç”µè¯ (WhatsApp)</th><th>å¤‡æ³¨</th><th>å†å²è®¢å•</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="custBody"></tbody>
        </table>
        <button id="btnSaveCust" class="btn btn-success btn-save-cloud" onclick="saveToGithub('customers')">ğŸ’¾ ä¿å­˜ã€å®¢æˆ·åˆ—è¡¨ã€‘åˆ° GitHub</button>
    </div>
    
    <p id="statusMsg" style="text-align: center; margin-top: 15px; color: #666;"></p>
</div>

<script src="products.js"></script>
<script src="customers.js"></script>

<script>
    // --- 1. åˆå§‹åŒ–ä¸é…ç½® ---
    let productList = (typeof allProducts !== 'undefined') ? allProducts : [];
    let customerList = (typeof allCustomers !== 'undefined') ? allCustomers : [];

    window.onload = function() {
        document.getElementById('ghOwner').value = localStorage.getItem('gh_owner') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
        renderProducts();
        renderCustomers();
    };

    function saveConfig() {
        localStorage.setItem('gh_owner', document.getElementById('ghOwner').value);
        localStorage.setItem('gh_repo', document.getElementById('ghRepo').value);
        localStorage.setItem('gh_token', document.getElementById('ghToken').value);
        alert("é…ç½®å·²ä¿å­˜ï¼");
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    }

    // --- 2. äº§å“é€»è¾‘ ---
    function renderProducts() {
        const tbody = document.getElementById('prodBody');
        const term = document.getElementById('prodSearch').value.toLowerCase();
        tbody.innerHTML = '';
        
        productList.forEach((p, i) => {
            if(!p.name.toLowerCase().includes(term)) return;
            tbody.innerHTML += `
                <tr>
                    <td><span class="badge ${p.active?'active-badge':'inactive-badge'}" onclick="toggleProd(${i})">${p.active?'ä¸Šæ¶':'ä¸‹æ¶'}</span></td>
                    <td contenteditable="true" onblur="updateProd(${i}, 'id', this.innerText)">${p.id}</td>
                    <td><img src="${p.image}" style="height:30px"></td>
                    <td contenteditable="true" onblur="updateProd(${i}, 'name', this.innerText)">${p.name}</td>
                    <td contenteditable="true" onblur="updateProd(${i}, 'price', this.innerText)">${p.price}</td>
                    <td><button class="btn btn-danger" onclick="delProd(${i})">åˆ </button></td>
                </tr>`;
        });
    }
    
    function addNewProduct() {
        productList.push({ id: "new-"+Date.now(), name: "æ–°äº§å“", price: 0, image: "product_images/cup.jpg", active: false });
        renderProducts();
    }
    function updateProd(i, key, val) { productList[i][key] = (key==='price') ? parseFloat(val) : val; }
    function toggleProd(i) { productList[i].active = !productList[i].active; renderProducts(); }
    function delProd(i) { if(confirm("åˆ é™¤?")) { productList.splice(i,1); renderProducts(); } }


    // --- 3. å®¢æˆ·é€»è¾‘ (CRMæ ¸å¿ƒ) ---
    function renderCustomers() {
        const tbody = document.getElementById('custBody');
        const term = document.getElementById('custSearch').value.toLowerCase();
        tbody.innerHTML = '';

        customerList.forEach((c, i) => {
            if(!c.name.toLowerCase().includes(term) && !c.phone.includes(term)) return;
            
            // è®¡ç®—æ€»æ¶ˆè´¹
            let totalSpent = c.history ? c.history.reduce((sum, h) => sum + (h.amount||0), 0) : 0;

            tbody.innerHTML += `
                <tr>
                    <td contenteditable="true" onblur="updateCust(${i}, 'name', this.innerText)">${c.name}</td>
                    <td>
                        <span contenteditable="true" onblur="updateCust(${i}, 'phone', this.innerText)">${c.phone}</span>
                        <a href="https://wa.me/${c.phone}" target="_blank" class="btn-whatsapp">ğŸ“² Chat</a>
                    </td>
                    <td contenteditable="true" onblur="updateCust(${i}, 'notes', this.innerText)">${c.notes || ''}</td>
                    <td>
                        <button class="btn" onclick="toggleHistory(${i})">ğŸ“œ è®¢å•(${c.history?c.history.length:0})</button>
                        <button class="btn btn-primary" style="padding:4px 8px;font-size:0.8rem" onclick="addOrder(${i})">+ è®°å•</button>
                    </td>
                    <td><button class="btn btn-danger" onclick="delCust(${i})">åˆ </button></td>
                </tr>
                <tr id="hist-row-${i}" class="history-row">
                    <td colspan="5">
                        <div class="history-box">
                            <strong>ğŸ›’ è´­ä¹°å†å² (æ€»æ¶ˆè´¹: $${totalSpent})</strong>
                            ${c.history && c.history.length > 0 ? c.history.map(h => `
                                <div class="history-item">
                                    <span>ğŸ“… ${h.date} | ğŸ“„ ${h.invoice}</span>
                                    <span>${h.items} | <strong>$${h.amount}</strong></span>
                                </div>
                            `).join('') : '<p>æš‚æ— è®°å½•</p>'}
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function addNewCustomer() {
        customerList.push({ id: "cust-"+Date.now(), name: "æ–°å®¢æˆ·", phone: "60", notes: "", history: [] });
        renderCustomers();
    }
    function updateCust(i, key, val) { customerList[i][key] = val; }
    function delCust(i) { if(confirm("åˆ é™¤æ­¤å®¢æˆ·?")) { customerList.splice(i,1); renderCustomers(); } }
    
    function toggleHistory(i) {
        const row = document.getElementById(`hist-row-${i}`);
        row.style.display = row.style.display === 'table-row' ? 'none' : 'table-row';
    }

    // æ‰‹åŠ¨æ·»åŠ è®¢å• (CRMåŠŸèƒ½)
    function addOrder(i) {
        const amount = prompt("è¯·è¾“å…¥è®¢å•é‡‘é¢ ($):", "25");
        if(amount === null) return;
        const items = prompt("ä¹°äº†ä»€ä¹ˆäº§å“?", "å’–å•¡æ¯");
        
        if(!customerList[i].history) customerList[i].history = [];
        
        customerList[i].history.unshift({
            date: new Date().toISOString().split('T')[0],
            invoice: "INV-" + Math.floor(Math.random()*10000),
            items: items || "æœªçŸ¥å•†å“",
            amount: parseFloat(amount)
        });
        renderCustomers();
        // è‡ªåŠ¨å±•å¼€å†å²è®°å½•
        document.getElementById(`hist-row-${i}`).style.display = 'table-row';
    }


    // --- 4. æ ¸å¿ƒï¼šä¿å­˜åˆ° GitHub ---
    async function saveToGithub(type) {
        const owner = document.getElementById('ghOwner').value;
        const repo = document.getElementById('ghRepo').value;
        const token = document.getElementById('ghToken').value;

        if(!owner || !repo || !token) return alert("è¯·å…ˆåœ¨é¡¶éƒ¨å¡«å†™ GitHub é…ç½®ï¼");

        // æ ¹æ®ç±»å‹å†³å®šå­˜å“ªä¸ªæ–‡ä»¶
        const fileName = (type === 'products') ? 'products.js' : 'customers.js';
        const dataToSave = (type === 'products') ? productList : customerList;
        const variableName = (type === 'products') ? 'allProducts' : 'allCustomers';
        const extraCode = (type === 'products') ? '\n\nconst products = allProducts.filter(p => p.active === true);' : '';

        const btn = document.getElementById(type === 'products' ? 'btnSaveProd' : 'btnSaveCust');
        const msg = document.getElementById('statusMsg');
        const originalText = btn.innerText;
        
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨è¿æ¥ GitHub...";

        try {
            // 1. è·å– SHA
            const getUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`;
            const getRes = await fetch(getUrl, { headers: { "Authorization": `token ${token}` } });
            if(!getRes.ok) throw new Error("æ–‡ä»¶ä¸å­˜åœ¨æˆ–Tokené”™è¯¯");
            const getJson = await getRes.json();

            // 2. å‡†å¤‡å†…å®¹
            const jsonString = JSON.stringify(dataToSave, null, 4);
            const newContent = `// è¿™æ˜¯ä½ çš„â€œ${type==='products'?'æ€»æ•°æ®åº“':'å®¢æˆ·æ•°æ®åº“'}â€\n// ä»¥å admin.html ä¼šè‡ªåŠ¨ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶\nconst ${variableName} = ${jsonString};${extraCode}`;
            const contentEncoded = btoa(unescape(encodeURIComponent(newContent)));

            // 3. ä¸Šä¼ 
            const putRes = await fetch(getUrl, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: `Update ${fileName} via Admin Panel`,
                    content: contentEncoded,
                    sha: getJson.sha
                })
            });

            if (putRes.ok) {
                alert(`âœ… ${fileName} æ›´æ–°æˆåŠŸï¼Netlify å°†è‡ªåŠ¨å¤‡ä»½ã€‚`);
                msg.innerText = "ä¸Šæ¬¡ä¿å­˜æˆåŠŸ: " + new Date().toLocaleTimeString();
            } else {
                throw new Error("ä¿å­˜å¤±è´¥");
            }
        } catch (err) {
            alert("âŒ é”™è¯¯: " + err.message);
        }
        btn.disabled = false;
        btn.innerText = originalText;
    }
</script>

</body>
</html>
