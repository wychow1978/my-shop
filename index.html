<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æç®€å•†åº—</title>
    <style>
        /* ä¿æŒä¹‹å‰çš„æç®€æ ·å¼ */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; color: #333; background-color: #f9f9f9; }
        nav { display: flex; justify-content: space-between; align-items: center; padding: 20px 5%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .cart-icon { cursor: pointer; padding: 8px 15px; background: #333; color: white; border-radius: 20px; font-size: 0.9rem; }
        .hero { text-align: center; padding: 80px 20px; background-image: url('https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&w=1200&q=80'); background-size: cover; color: white; position: relative; }
        .hero::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); }
        .hero-content { position: relative; z-index: 1; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .container { max-width: 1000px; margin: 60px auto; padding: 0 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 40px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; padding-bottom: 20px; }
        .product-img { width: 100%; height: 250px; object-fit: cover; }
        .product-title { margin: 15px 0 5px; font-weight: bold; }
        .product-price { color: #888; display: block; margin-bottom: 15px; }
        .add-btn { background: #333; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
        .add-btn:hover { background: #555; }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; text-align: left; }
        .cart-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        .total-section { text-align: right; font-weight: bold; margin-top: 20px; font-size: 1.2rem; }
        .btn-group { margin-top: 20px; display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-align: center; }
        .btn-pay { background: #25D366; color: white; } /* WhatsApp Green */
        .btn-close { background: #eee; color: #333; }
        
        .qr-area { text-align: center; margin-top: 20px; display: none; }
        .qr-img { width: 200px; height: 200px; object-fit: contain; border: 1px dashed #ccc; margin-bottom: 10px; }
        
        input { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

    <form name="orders" netlify hidden>
        <input type="text" name="order_id" />
        <input type="text" name="customer_name" />
        <input type="text" name="total_price" />
        <textarea name="items"></textarea>
    </form>

    <nav>
        <div class="logo">MyShop.</div>
        <div class="cart-icon" onclick="openCart()">
            ğŸ›’ <span id="cartCount">0</span>
        </div>
    </nav>

    <header class="hero">
        <div class="hero-content">
            <h1>ç²¾é€‰å¥½ç‰©</h1>
            <p>ç®€çº¦ç”Ÿæ´»ï¼Œä»è¿™é‡Œå¼€å§‹</p>
        </div>
    </header>

    <div class="container">
        <div class="product-grid" id="productContainer">
            </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <h2>è´­ç‰©è½¦</h2>
            <div id="cartList"></div>
            <div class="total-section">æ€»è®¡: $<span id="totalPrice">0</span></div>

            <div id="customerForm">
                <input type="text" id="custName" placeholder="æ‚¨çš„åå­— (ç”¨äºæ ¸å¯¹è®¢å•)" />
            </div>

            <div class="qr-area" id="qrArea">
                <p>è®¢å•å·: <strong id="invoiceId"></strong></p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ReplaceWithYourBankQR" class="qr-img">
                <p style="font-size: 0.8rem; color: #666;">è¯·æ‰«ç æ”¯ä»˜ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€šçŸ¥æˆ‘ã€‚</p>
            </div>

            <div class="btn-group">
                <button class="action-btn btn-close" onclick="closeCart()">å…³é—­</button>
                <button class="action-btn btn-pay" id="mainBtn" onclick="handleCheckout()">å»ä¹°å•</button>
            </div>
        </div>
    </div>

    <script src="products.js"></script>
    
    <script>
        // æ¸²æŸ“äº§å“åˆ—è¡¨
        const container = document.getElementById('productContainer');
        products.forEach(p => {
            container.innerHTML += `
                <div class="product-card">
                    <img src="${p.image}" class="product-img">
                    <div class="product-title">${p.name}</div>
                    <span class="product-price">$${p.price}</span>
                    <button class="add-btn" onclick="addToCart('${p.id}')">åŠ å…¥è´­ç‰©è½¦</button>
                </div>
            `;
        });

        // è´­ç‰©è½¦é€»è¾‘
        let cart = [];
        
        function addToCart(id) {
            const product = products.find(p => p.id === id);
            cart.push(product);
            updateCartUI();
            alert(`${product.name} å·²åŠ å…¥!`);
        }

        function updateCartUI() {
            document.getElementById('cartCount').innerText = cart.length;
        }

        function openCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            let total = 0;
            
            if(cart.length === 0) {
                list.innerHTML = '<p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>';
            } else {
                cart.forEach((item, index) => {
                    total += item.price;
                    list.innerHTML += `
                        <div class="cart-item">
                            <span>${item.name}</span>
                            <span>$${item.price} <small onclick="removeItem(${index})" style="color:red;cursor:pointer;">[x]</small></span>
                        </div>
                    `;
                });
            }
            document.getElementById('totalPrice').innerText = total;
            document.getElementById('cartModal').style.display = 'flex';
        }

        function removeItem(index) {
            cart.splice(index, 1);
            openCart(); // é‡æ–°æ¸²æŸ“
            updateCartUI();
        }

        function closeCart() {
            document.getElementById('cartModal').style.display = 'none';
            // é‡ç½®ç•Œé¢
            document.getElementById('qrArea').style.display = 'none';
            document.getElementById('customerForm').style.display = 'block';
            document.getElementById('mainBtn').innerText = "å»ä¹°å•";
            document.getElementById('mainBtn').onclick = handleCheckout;
        }

        // æ ¸å¿ƒæµç¨‹ï¼šä¹°å• -> ç”Ÿæˆå•å· -> å­˜Netlify -> è·³WhatsApp
        function handleCheckout() {
            if(cart.length === 0) return alert('è´­ç‰©è½¦æ˜¯ç©ºçš„');
            
            const name = document.getElementById('custName').value;
            if(!name) return alert('è¯·å…ˆè¾“å…¥æ‚¨çš„åå­—');

            // 1. ç”Ÿæˆå•å·
            const invoice = "INV-" + Date.now().toString().slice(-6);
            document.getElementById('invoiceId').innerText = invoice;

            // 2. åˆ‡æ¢ç•Œé¢æ˜¾ç¤ºäºŒç»´ç 
            document.getElementById('customerForm').style.display = 'none';
            document.getElementById('qrArea').style.display = 'block';
            document.getElementById('mainBtn').innerText = "âœ… æˆ‘å·²æ”¯ä»˜ (å‘é€å›æ‰§)";
            
            // 3. å‡†å¤‡æ•°æ®å‘é€ç»™ Netlify å’Œ WhatsApp
            document.getElementById('mainBtn').onclick = () => finishOrder(name, invoice);
        }

        function finishOrder(name, invoice) {
            let total = 0;
            let itemsText = cart.map(i => { total += i.price; return i.name; }).join(", ");

            // --- A. å‘é€æ•°æ®åˆ° Netlify (åå°å¤‡ä»½) ---
            // åˆ›å»ºä¸€ä¸ªè¡¨å•æ•°æ®å¯¹è±¡
            const formData = new FormData();
            formData.append("form-name", "orders");
            formData.append("order_id", invoice);
            formData.append("customer_name", name);
            formData.append("total_price", total);
            formData.append("items", itemsText);

            // ä½¿ç”¨ fetch API å·å·æäº¤
            fetch("/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams(formData).toString()
            }).then(() => console.log("Netlify Backup Success")).catch(e => console.error(e));

            // --- B. è·³è½¬ WhatsApp (ä¸»è¦äº¤äº’) ---
            const myPhone = "60167179854"; // âš ï¸ æ”¹æˆä½ çš„å·ç 
            const msg = `ä½ å¥½ï¼Œæˆ‘æ˜¯ ${name}ã€‚%0Aæˆ‘å·²å®Œæˆæ”¯ä»˜ï¼ğŸ§¾%0A%0Aè®¢å•å·: ${invoice}%0Aæ€»é‡‘é¢: $${total}%0Aè´­ä¹°å•†å“: ${itemsText}`;
            window.open(`https://wa.me/${myPhone}?text=${msg}`, '_blank');
            
            // æ¸…ç©ºè´­ç‰©è½¦
            cart = [];
            updateCartUI();
            closeCart();
        }
    </script>
</body>
</html>