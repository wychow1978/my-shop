<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æç®€å•†åº—</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 0; background-color: #f9f9f9; color: #333; }
        
        /* å¯¼èˆªæ  */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .user-status { font-size: 0.9rem; color: #666; }
        .cart-icon { cursor: pointer; padding: 8px 15px; background: #333; color: white; border-radius: 20px; font-size: 0.9rem; position: relative; }
        .cart-badge { background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; position: absolute; top: -5px; right: -5px; }

        /* äº§å“åˆ—è¡¨ */
        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; padding-bottom: 20px; transition: 0.3s; }
        .product-card:hover { transform: translateY(-5px); }
        .product-img { width: 100%; height: 250px; object-fit: cover; }
        .product-info { padding: 15px; }
        .add-btn { background: #333; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 0.9rem; }
        .add-btn:hover { background: #555; }

        /* é€šç”¨æ¨¡æ€æ¡† (Modal) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background-color: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; position: relative; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }

        /* ç™»å½•/æ³¨å†Œè¡¨å•æ ·å¼ */
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .auth-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #999; font-weight: bold; }
        .auth-tab.active { color: #333; border-bottom: 2px solid #333; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 12px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 10px; }
        .btn-whatsapp { background: #25D366; }

        /* è´­ç‰©è½¦åˆ—è¡¨ */
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <form name="registrations" netlify hidden>
        <input type="text" name="name" />
        <input type="text" name="phone" />
        <input type="text" name="country" />
        <input type="text" name="password" />
    </form>

    <nav>
        <div class="logo">MyShop.</div>
        <div class="nav-right">
            <span id="welcomeMsg" class="user-status" onclick="logout()"></span>
            <div class="cart-icon" onclick="openCart()">
                ğŸ›’ <span id="cartCount" class="cart-badge">0</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="product-grid" id="productContainer">
            </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAuth()">&times;</span>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuth('login')">ç™»å½•</div>
                <div class="auth-tab" onclick="switchAuth('register')">æ³¨å†Œæ–°ä¼šå‘˜</div>
            </div>

            <div id="form-login" class="auth-form active">
                <div class="form-group">
                    <label>ç”µè¯å·ç </label>
                    <input type="text" id="loginPhone" placeholder="è¯·è¾“å…¥æ³¨å†Œæ—¶çš„æ‰‹æœºå·">
                </div>
                <button class="btn-submit" onclick="handleLogin()">ç™»å½•</button>
            </div>

            <div id="form-register" class="auth-form">
                <div class="form-group">
                    <label>å§“å (çœŸå®å§“å)</label>
                    <input type="text" id="regName" placeholder="ä¾‹å¦‚: John Doe">
                </div>
                <div class="form-group">
                    <label>å›½å®¶/åœ°åŒº</label>
                    <select id="regCountry">
                        <option value="+60">ğŸ‡²ğŸ‡¾ é©¬æ¥è¥¿äºš (+60)</option>
                        <option value="+65">ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (+65)</option>
                        <option value="+86">ğŸ‡¨ğŸ‡³ ä¸­å›½ (+86)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç”µè¯å·ç </label>
                    <input type="text" id="regPhone" placeholder="ä¾‹å¦‚: 123456789">
                </div>
                <div class="form-group">
                    <label>è®¾ç½®å¯†ç  (ç”¨äºç§¯åˆ†æŸ¥è¯¢)</label>
                    <input type="password" id="regPass" placeholder="******">
                </div>
                <button class="btn-submit" onclick="handleRegister()">åˆ›å»ºè´¦æˆ·</button>
            </div>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCart()">&times;</span>
            <h2>æˆ‘çš„è´­ç‰©è½¦</h2>
            <div id="cartList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;"></div>
            <div style="text-align: right; font-weight: bold; font-size: 1.2rem; margin-bottom: 20px;">
                æ€»è®¡: $<span id="totalPrice">0</span>
            </div>
            
            <div id="paymentArea" style="display:none; text-align:center;">
                <p>è®¢å•å·: <strong id="invoiceId"></strong></p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=ExampleBankQR" style="margin:10px auto;">
                <p style="font-size:0.8rem; color:#666;">è¯·æ‰«ç æ”¯ä»˜ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹å‘é€å›æ‰§ã€‚</p>
            </div>

            <button id="checkoutBtn" class="btn-submit btn-whatsapp" onclick="handleCheckout()">å»ç»“è´¦ (WhatsApp)</button>
        </div>
    </div>

    <script src="products.js"></script>

    <script>
        let cart = [];
        let currentUser = null; // å­˜å‚¨å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯ {name, phone, country}

        // --- åˆå§‹åŒ–: æ£€æŸ¥æ˜¯å¦å·²ç™»å½• ---
        window.onload = function() {
            renderProducts();
            const savedUser = localStorage.getItem('myshop_user');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserUI();
            }
        };

        function renderProducts() {
            const container = document.getElementById('productContainer');
            // åªæ˜¾ç¤º active çš„äº§å“ (é˜²æ­¢ products æœªå®šä¹‰)
            const list = (typeof products !== 'undefined') ? products : [];
            container.innerHTML = '';
            list.forEach(p => {
                container.innerHTML += `
                    <div class="product-card">
                        <img src="${p.image}" class="product-img">
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            <span style="color:#888; display:block; margin-bottom:5px;">$${p.price}</span>
                            <button class="add-btn" onclick="addToCart('${p.id}')">åŠ å…¥è´­ç‰©è½¦</button>
                        </div>
                    </div>`;
            });
        }

        // --- ç™»å½•/æ³¨å†Œ é€»è¾‘ ---
        function checkLogin() {
            if(!currentUser) {
                document.getElementById('authModal').style.display = 'flex';
                return false;
            }
            return true;
        }

        function switchAuth(type) {
            document.querySelectorAll('.auth-tab').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(e => e.classList.remove('active'));
            
            if(type === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('form-login').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('form-register').classList.add('active');
            }
        }

        function closeAuth() { document.getElementById('authModal').style.display = 'none'; }

        function handleRegister() {
            const name = document.getElementById('regName').value;
            const country = document.getElementById('regCountry').value;
            const phone = document.getElementById('regPhone').value;
            const pass = document.getElementById('regPass').value;

            if(!name || !phone || !pass) return alert("è¯·å¡«å†™å®Œæ•´èµ„æ–™");

            // 1. ä¿å­˜åˆ°æœ¬åœ° (æ¨¡æ‹Ÿç™»å½•æˆåŠŸ)
            currentUser = { name, country, phone };
            localStorage.setItem('myshop_user', JSON.stringify(currentUser));

            // 2. å‘é€æ•°æ®ç»™ Netlify Form (Adminåå°å¯è§)
            const formData = new FormData();
            formData.append("form-name", "registrations");
            formData.append("name", name);
            formData.append("country", country);
            formData.append("phone", phone);
            formData.append("password", pass);
            
            fetch("/", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: new URLSearchParams(formData).toString() })
                .then(() => console.log("Registered to Netlify"));

            alert("æ³¨å†ŒæˆåŠŸï¼æ¬¢è¿, " + name);
            updateUserUI();
            closeAuth();
        }

        function handleLogin() {
            const phone = document.getElementById('loginPhone').value;
            if(!phone) return alert("è¯·è¾“å…¥ç”µè¯");

            // ç®€å•æ¨¡æ‹Ÿ: åªè¦è¾“å…¥äº†ç”µè¯å°±ç®—ç™»å½• (å®é™…é¡¹ç›®éœ€è¦éªŒè¯)
            // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å­˜åœ¨
            currentUser = { name: "è€é¡¾å®¢", phone: phone, country: "+60" };
            localStorage.setItem('myshop_user', JSON.stringify(currentUser));
            
            updateUserUI();
            closeAuth();
        }

        function logout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('myshop_user');
                currentUser = null;
                updateUserUI();
            }
        }

        function updateUserUI() {
            const msg = document.getElementById('welcomeMsg');
            if(currentUser) {
                msg.innerHTML = `ğŸ‘‹ Hi, ${currentUser.name} (é€€å‡º)`;
                msg.style.cursor = "pointer";
            } else {
                msg.innerHTML = "";
            }
        }

        // --- è´­ç‰©è½¦é€»è¾‘ ---
        function addToCart(id) {
            // å…³é”®ï¼šç‚¹å‡»åŠ å…¥è´­ç‰©è½¦æ—¶ï¼Œå¼ºåˆ¶æ£€æŸ¥ç™»å½•
            if(!checkLogin()) return;

            const product = products.find(p => p.id === id);
            cart.push(product);
            updateCartCount();
            alert("å·²åŠ å…¥è´­ç‰©è½¦");
        }

        function updateCartCount() { document.getElementById('cartCount').innerText = cart.length; }

        function openCart() {
            if(!checkLogin()) return; // æ‰“å¼€è´­ç‰©è½¦ä¹Ÿè¦æ£€æŸ¥
            
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            let total = 0;
            if(cart.length === 0) list.innerHTML = "<p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>";
            cart.forEach((item, index) => {
                total += item.price;
                list.innerHTML += `
                    <div class="cart-item">
                        <span>${item.name}</span>
                        <span>$${item.price} <small style="color:red;cursor:pointer" onclick="removeItem(${index})">[x]</small></span>
                    </div>`;
            });
            document.getElementById('totalPrice').innerText = total;
            document.getElementById('cartModal').style.display = 'flex';
        }

        function removeItem(i) { cart.splice(i, 1); openCart(); updateCartCount(); }
        function closeCart() { document.getElementById('cartModal').style.display = 'none'; }

        // --- ç»“è´¦é€»è¾‘ ---
        function handleCheckout() {
            if(cart.length === 0) return;

            const btn = document.getElementById('checkoutBtn');
            const paymentArea = document.getElementById('paymentArea');
            const total = document.getElementById('totalPrice').innerText;
            const invoice = "INV-" + Date.now().toString().slice(-5);

            // ç¬¬ä¸€æ­¥: æ˜¾ç¤ºäºŒç»´ç 
            if(paymentArea.style.display === 'none') {
                document.getElementById('invoiceId').innerText = invoice;
                paymentArea.style.display = 'block';
                btn.innerText = "âœ… æˆ‘å·²ä»˜æ¬¾ (å‘é€WhatsAppé€šçŸ¥)";
                return;
            }

            // ç¬¬äºŒæ­¥: è·³è½¬WhatsApp
            const itemsText = cart.map(i => i.name).join(", ");
            // ç»„åˆæ¶ˆæ¯: åŒ…å«é¡¾å®¢èµ„æ–™ (æ–¹ä¾¿Adminå½•å…¥)
            const msg = `*æ–°è®¢å•!* %0A----------------%0AğŸ‘¤ å®¢æˆ·: ${currentUser.name}%0AğŸ“ ç”µè¯: ${currentUser.country} ${currentUser.phone}%0AğŸ§¾ å•å·: ${invoice}%0AğŸ’° æ€»é¢: $${total}%0AğŸ“¦ å•†å“: ${itemsText}%0A----------------%0Aæˆ‘å·²ç»å®Œæˆä»˜æ¬¾ï¼Œè¯·æŸ¥æ”¶ï¼`;
            
            window.open(`https://wa.me/60123456789?text=${msg}`, '_blank'); // âš ï¸ è®°å¾—æ”¹ä½ çš„ç”µè¯
            
            // æ¸…ç©º
            cart = [];
            updateCartCount();
            closeCart();
            location.reload();
        }
    </script>
</body>
</html>
